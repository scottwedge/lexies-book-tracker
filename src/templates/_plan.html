<div class="book" id="plan-{{ plan.id }}">
  <div class="info">
    <div class="book-preview">
      <div class="book-thumbnail"><img src="{{ plan.book.image_url}}"></div>
      <div class="book-metadata">
        <h3 class="book-title">
          {{ plan.book.title }}
        </h3>
        {% if plan.book.author or plan.book.year %}
          {{ plan.book.author }}
          {%- if plan.book.author and plan.book.year %},{% endif %}
          {{ plan.book.year }}
        {% endif %}

        <div class="plan-note">
          {% if plan.note %}
            {% for line in plan.note.splitlines() %}
              {% if line %}
                <p>{{ line }}</p>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>

    {% if user == current_user %}
    <div class="actions">
      <button class="edit-plan" data-planid="{{ plan.id }}">
        edit
      </button>

      <button class="mark-as-read" data-planid="{{ plan.id }}">
        mark as read
      </button>

      <form
        action="{{ url_for('move_plan_to_reading', plan_id=plan.id) }}"
        method="POST">
        <button class="mark-as-reading" data-planid="{{ plan.id }}">
          mark as reading
        </button>
      </form>

      <form
        action="{{ url_for('delete_plan', plan_id=plan.id) }}"
        method="POST"
        class="delete-button"
        onsubmit="return confirmDeletion{{ plan.id }}();"
      >
        <button type="submit" class="delete-book">
          delete
        </button>
      </form>
    </div>
    {% endif %}

  </div>

  {% if user == current_user %}
    <script>
      function confirmDeletion{{ plan.id }}() {
        return confirm('Are you sure you want to remove ' + {{ plan.book.title|to_json|safe }} + '?');
      }
    </script>

    <form
      action="{{ url_for('edit_plan', plan_id=plan.id) }}"
      method="POST"
      class="hidden plan-edit-form"
    >
      {{ edit_form.hidden_tag() }}

      <p>
        {{ edit_form.note.label }}
        <textarea id="note" name="note">{{ plan.note }}</textarea>
      </p>

      <button type="button" class="cancel-edit">
        cancel
      </button>

      <button type="submit">
        update
      </button>
    </form>

    <form
      action="{{ url_for('mark_plan_as_read', plan_id=plan.id) }}"
      method="POST"
      class="hidden mark-as-read-form"
    >
      {{ review_form.hidden_tag() }}

      <p>
        {{ review_form.review_text.label }}
        <textarea id="review_text" name="review_text">{{ plan.note }}</textarea>
      </p>

      <div class="half-width">
        {{ review_form.is_favourite() }}
        {{ review_form.is_favourite.label }}
      </div>
      <div class="half-width">
        {{ review_form.did_not_finish() }}
        {{ review_form.did_not_finish.label }}
      </div>

      <p>
        {{ review_form.date_read.label }}<br/>
        {{ review_form.date_read() }}
      </p>

      <button type="button" class="cancel-add-review">
        cancel
      </button>

      <button type="submit">
        mark as read
      </button>
    </form>
  {% endif %}
</div>
