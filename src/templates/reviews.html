{% extends "_booklist.html" %}

{% block add_book_form %}
<form method="POST" id="selected" action="{{ url_for('add_review', username=user.username) }}" class="hidden">
  {{ review_form.hidden_tag() }}
  <div id="info"></div>

  {{ review_form.title(type="hidden", id="title") }}
  {{ review_form.author(type="hidden", id="author") }}
  {{ review_form.image_url(type="hidden", id="image_url") }}
  {{ review_form.source_id(type="hidden", id="source_id") }}
  {{ review_form.year(type="hidden", id="year") }}
  {{ review_form.identifiers(type="hidden", id="identifiers") }}

  <p>
    {{ review_form.review_text.label }}<br/>
    {{ review_form.review_text(rows=3) }}
  </p>

  <div class="half-width">
    {{ review_form.is_favourite() }}
    {{ review_form.is_favourite.label }}
  </div>
  <div class="half-width">
    {{ review_form.did_not_finish() }}
    {{ review_form.did_not_finish.label }}
  </div>

  <p>
    {{ review_form.date_read.label }}<br/>
    {{ review_form.date_read() }}
  </p>
  <button type="submit">add</button>
</form>
{% endblock %}

{% block booklist_content %}
<style>
  .book {
    border: 1px solid #00a892;
/*    display: inline-block;*/
    margin-bottom: 1em;
    border-radius: 5px;
    background: rgba(0, 255, 221, 0.2);
  }

  .book-description, .actions {
    padding: 15px;
  }

  .book-description {
    padding-top: 0;
    padding-bottom: 0;
  }

  .actions button, .actions form {
    display: inline-block;
  }

  .actions {
    text-align: right;
  }

  div.book--is_favourite {
    border-width: 5px;
    margin-top: -4px;
    margin-right: -4px;
    margin-left: -4px;
    margin-bottom: calc(1em - 4px);
  }

  div.book--did_not_finish {
    opacity: 0.5;
  }

  div.book h3 {
    margin-top: 0;
    font-weight: normal;
    line-height: 1.25em;
  }

  .book .image {
    text-align: center;
  }

  .book a, .book a:visited {
    color: black;
  }

  .book-metadata a:hover {
    background: rgba(0, 0, 0, 0.3);
  }

  div.actions {
    padding-top: 0;
  }

  .actions button {
    cursor: pointer;
  }
</style>

  {% if reviews %}
    <div class="books">
    {% for review in reviews %}
      {% include "_review.html" %}
    {% endfor %}
    </div>
  {% else %}
    <p>
      {% if user == current_user %}
        You haven't read any books yet!
      {% else %}
        {{ user }} hasn't read any books yet!
      {% endif %}
    </p>
  {% endif %}

  <script>
    class Books {
      constructor(container) {
        this.container = container;
        this.editing = null;
      }

      addEventListeners() {
        [...document.querySelectorAll(".edit-book")].forEach(item => {
          item.addEventListener("click", evt => {
            if (this.editing === null) {
              this.editing = parseInt(evt.target.dataset["bookid"]);
            } else {
              this.editing = null;
            }
            this.renderEditing();
          });
        });
        [...document.querySelectorAll(".cancel-edit")].forEach(item => {
          item.addEventListener("click", evt => {
            this.editing = null;
            this.renderEditing();
          });
        });
      }

      renderEditing() {
        const div = document.getElementById("book-" + this.editing);

        if (this.editing) {
          const form = div.querySelector(".book-edit-form");

          form.classList.remove("hidden");
        } else {
          [...document.querySelectorAll(".book-edit-form")].forEach(item => {
            item.classList.add("hidden");
          });
        }
      }
    }

    const container = document.querySelector(".books");
    if (container) {
      const books = new Books(container);
      books.addEventListeners();
    }
  </script>
{% endblock %}
